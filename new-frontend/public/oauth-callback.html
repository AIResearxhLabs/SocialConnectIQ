<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connecting...</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .status-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .success {
            color: #10b981;
        }

        .error {
            color: #ef4444;
        }

        .loader {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="content">
        <div class="loader"></div>
        <p>Completing authentication...</p>
    </div>

    <script>
        window.onload = function () {
            // DEBUG: Print current URL to page (temporary)
            console.log("Current URL:", window.location.href);

            const params = new URLSearchParams(window.location.search);
            const status = params.get('status');
            const platform = params.get('platform');
            const message = params.get('message');

            const contentDiv = document.getElementById('content');

            if (status === 'success') {
                // User Feedback & Manual Override
                contentDiv.innerHTML = `
                    <div class="status-icon success">✓</div>
                    <h2>Connected Successfully!</h2>
                    <p>You have successfully connected to ${platform || 'the platform'}.</p>
                    <p>This window should close automatically.</p>
                    <button id="manual-close-btn" style="margin-top:20px; padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        Click here if window doesn't close
                    </button>
                    <p style="font-size: 12px; color: #6b7280; margin-top: 10px;">Debug: ${platform} | ${status}</p>
                `;

                // Notify parent window function
                const notifyAndClose = () => {
                    const channel = new BroadcastChannel('social_connect_auth');
                    channel.postMessage({ type: 'OAUTH_SUCCESS', platform: platform });

                    if (window.opener) {
                        try {
                            window.opener.postMessage({ type: 'OAUTH_SUCCESS', platform: platform }, '*');
                        } catch (e) {
                            console.error("Window opener postMessage failed", e);
                        }
                    }
                    setTimeout(() => window.close(), 200);
                };

                // Auto Trigger
                const channel = new BroadcastChannel('social_connect_auth');
                channel.postMessage({ type: 'OAUTH_SUCCESS', platform: platform });
                if (window.opener) {
                    try {
                        window.opener.postMessage({ type: 'OAUTH_SUCCESS', platform: platform }, '*');
                    } catch (e) { }
                }
                setTimeout(() => window.close(), 2500); // Increased timeout to let user see success

                // Manual Trigger
                const btn = document.getElementById('manual-close-btn');
                if (btn) btn.addEventListener('click', notifyAndClose);
            } else if (status === 'error') {
                contentDiv.innerHTML = `
                    <div class="status-icon error">✕</div>
                    <h2>Connection Failed</h2>
                    <p>${message ? decodeURIComponent(message) : 'An unknown error occurred.'}</p>
                    <button onclick="window.close()" style="margin-top:20px; padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Close Window</button>
                `;
                if (window.opener) {
                    window.opener.postMessage({ type: 'OAUTH_ERROR', platform: platform, message: message }, '*');
                }
            } else {
                // Fallback / Debug State
                contentDiv.innerHTML = `
                    <div class="loader"></div>
                    <h2>Status Unknown</h2>
                    <p>Parameters received:</p>
                    <pre style="text-align: left; background: #e5e7eb; padding: 10px; border-radius: 4px; overflow: auto; max-width: 90%;">
Status: ${status || 'null'}
Platform: ${platform || 'null'}
URL: ${window.location.href}
                    </pre>
                    <button id="force-close-btn" style="margin-top:20px; padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Force Success & Close
                    </button>
                `;

                // Allow user to force close treating it as success (last resort)
                document.getElementById('force-close-btn').addEventListener('click', () => {
                    const channel = new BroadcastChannel('social_connect_auth');
                    channel.postMessage({ type: 'OAUTH_SUCCESS', platform: platform || 'linkedin' });
                    if (window.opener) window.opener.postMessage({ type: 'OAUTH_SUCCESS', platform: platform || 'linkedin' }, '*');
                    window.close();
                });
            }
        };
    </script>
</body>

</html>